<?php

require_once $_SERVER['DOCUMENT_ROOT'] . '/ProjetoBanco/codigo/ProjectFree/util/Constants.php';

require_once ROOT_FOLDER . '/util/Util.php';

require_once ROOT_FOLDER . '/util/PostgresConnect.php';

require_once ROOT_FOLDER . '/templates/header.php';
require_once ROOT_FOLDER . '/templates/footer.php';

require_once ROOT_FOLDER . '/entitys/Usuario.php';
require_once ROOT_FOLDER . '/entitys/Projeto.php';
require_once ROOT_FOLDER . '/entitys/Artefato.php';
require_once ROOT_FOLDER . '/entitys/Atividade.php';
require_once ROOT_FOLDER . '/entitys/Fase.php';

class Body {
	private $header;
	private $title;
	private $extraHeader;

	public function __construct() {
		$this->header = new Header();
		$this->header->setTitle($this->title);
		$this->header->setExtraHeader($this->extraHeader);
		$this->init();
		//$this->setHeaderType();
	}

	protected function init() {
		$this->header->loadHead();
		$this->loadBody();
		Footer::loadFooter();
	}

	protected function loadBody() {
		if (isset($_GET['exibir'])) {
			$this->exibir();
		}
		else if (isset($_GET['novo'])) {
			$this->novo();
		}
		else if (isset($_GET['exibir'])) {
			$this->exibir();
		}
		else if (isset($_POST['deletar'])) {
			$this->deletar();
		}
		else {
			$this->listar();
		}
	}



	protected function setHeaderType() {
		$url = $_SERVER['REQUEST_URI'];
		$entity = strtolower(str_replace('Page_', '', get_called_class()));
		if (!$this->checkLogin()) {
			if (strpos($url, '/logged/') !== false) {
				$this->storeloginOnSession(false);
				redirect('/ProjetoBanco/codigo/ProjectFree/application/index.php');
			}
		}
		else if (strpos($url, '/logged/') !== false) {
			$role = $this->getRole();
			session_start();
			$_SERVER['gerente'] = (strtolower($role) == 'gerente') ? true: false;
		}
	}

	protected function salvar() {
		$entity = strtolower(str_replace('Page_', '', get_called_class()));
		$parameters = array();
		foreach ($_POST as $fieldName => $fieldValue) {
			if ($fieldName == 'submit') {
				break;
			}
			$parameters[] = $fieldValue;
		}
		if ($entity == 'cadastro') {
			$entity = 'usuario';
		}
		$functionName = $entity . 'Cadastrar';


		$pgConnect = new PostgresConnection();
		$prepare = $pgConnect->prepareFunctionStatement($functionName, count($parameters));
		$retval = $pgConnect->executeFunctionStatement($functionName, $parameters);
		$result = $pgConnect->getResult($retval);

		if ($result != 0)
			printSuccessMessage('Sucesso ao cadastrar ' . $entity);
		else
			printErrorMessage('Erro ao tentar cadastrar ' . $entity);
	}

	protected function setTitle($title) {
		$this->title = $title;
	}

	protected function setExtraHeader($extraHeader) {
		$this->extraHeader = $extraHeader;
	}

	public function getUserId() {
		global $userId;
		return isset($userId) ? $userId : null;
	}

	public function getProjectId() {
		global $projectId;
		return isset($projectId) ? $projectId : null;
	}
}
