<?php

require_once $_SERVER['DOCUMENT_ROOT'] . '/ProjetoBanco/codigo/ProjectFree/util/Constants.php';

require_once ROOT_FOLDER . '/util/Util.php';

require_once ROOT_FOLDER . '/util/PostgresConnect.php';

require_once ROOT_FOLDER . '/templates/header.php';
require_once ROOT_FOLDER . '/templates/footer.php';

require_once ROOT_FOLDER . '/entitys/Usuario.php';
require_once ROOT_FOLDER . '/entitys/Projeto.php';

class Body {
	private $header;
	private $title;
	private $extraHeader;

	public function __construct() {
		$this->header = new Header();
		$this->header->setTitle($this->title);
		$this->header->setExtraHeader($this->extraHeader);
		$this->init();
		if (isset($_POST['submit'])) {
			$this->validateSave();
		}
	}

	protected function init() {
		$this->setHeaderType();
		$this->header->loadHead();
		$this->loadBody();
		Footer::loadFooter();
		$url = $_SERVER['REQUEST_URI'];
	}

	protected function setHeaderType() {
		if (!$this->checkLogin()) {
			$this->storeloginOnSession(false);
			$url = $_SERVER['REQUEST_URI'];
			if (strpos($url, '/logged/') !== false) {
				redirect('/ProjetoBanco/codigo/ProjectFree/application/index.php');
			}
		}
		else if (strpos($url, '/logged/') !== false) {
			echo 'here';
		}
	}

	protected function loadBody(){
		if (isset($_GET['novo']) && $_GET['novo'] == true) {
			$this->cadastrar();
		}
		else if (isset($_GET['exibir'])) {
			$this->exibir();
		}
		else {
			$this->listar();
		}
	}


	protected function setTitle($title) {
		$this->title = $title;
	}

	protected function setExtraHeader($extraHeader) {
		$this->extraHeader = $extraHeader;
	}

	protected function validateSave() {
		$entityWhitelist = array(
			'projeto', 'usuario', 'artefato' ,'fase', 'atividade',
			'fale_conosco', 'mensagem', 'recurso', 'despesa', 'nota',
			'imagem', 'comentario', 'forma_de_contato', 'doacao'
		);

		if (isset($_POST['submit']) && isset($_POST['entity'])
			&& isset($_POST['fields']) && in_array($_POST['entity'], $entityWhitelist)
		) {
			$this->save();
		}
		else{
			redirect('/ProjectFree/application');
		}
	}

	protected function save() {
		$fields = str_replace(' ', '', split(',', $_POST['fields']));
		$entity = ucfirst($_POST['entity']);

		$retval = checkMandatoryPostFields($fields);

		if ($retval['flag']) {
			$pgConnect = new PostgresConnection();

			$functionName = lcfirst($entity) . 'Cadastrar'; // ex: usuarioCadastrar


			$parameters = array();
			$obj = new $entity();
			foreach ($fields as $field) {
				$obj->{"set$field"}($_POST[$field]);
				$parameters[] = $obj->{"get$field"}();
			}

			$prepare = $pgConnect->prepareFunctionStatement($functionName, count($parameters));

			$retval = $pgConnect->executeFunctionStatement($functionName, $parameters);

			$result = $pgConnect->getResult($retval);

			$id = current(current($result));

			if (isset($id) && $id > 0) {
				printSuccessMessage($pgConnect->getNoticeString());
				$this->extraCallOnSucessOperation();
			}
			else {
				printErrorMessage($pgConnect->getErrorString());

			}

			$pgConnect->closeConnection();
		}
		else {
			printErrorMessage('É necessário preencher todos os campos obrigatórios !');
			?>
			<script type="text/javascript">
				<?php
				foreach ($retval['invalidFields'] as $invalidField) {
				?>
					$('input[name="<?php echo $invalidField;?>"]').css('background-color', 'black');
				<?php
				}
				if (!empty($retval['validFields'])) {
					foreach ($retval['validFields'] as $validField) {
					?>
						$('input[name="<?php echo $validField;?>"]').val('<?php echo $_POST[$validField];?>');
					<?php
					}
				}
				?>
			</script>
			<?php
		}
	}

	protected function show() {

	}

	protected function retrieveList($objectName, array $parameters, array $fields) {
		$pgConnect = new PostgresConnection();
		$functionName = $objectName . 'Listar'; // ex: usuarioCadastrar
		$prepare = $pgConnect->prepareFunctionStatement($functionName, count($parameters));
		$retval = $pgConnect->executeQueryWithParams("SELECT * FROM $functionName($1)", $parameters);
		$result = $pgConnect->getResult($retval);

		if ($result !== false) {
			foreach ($result as $projeto) {
				?>
				<tr>
					<?php
					$id = $projeto["id_$objectName"];
					$link = $objectName . '.php?exibir=' . $id;
					foreach ($fields as $field) {
						echo "<td><a href='$link'>$projeto[$field]</a></td>";
					}
					?>
				</tr>
				<?php
			}
		}
		else {
			printWarningMessage("Nenhum {$objectName} encontrado");
		}

		$pgConnect->closeConnection();

	}

	public function getUserId() {
		global $userId;
		return isset($userId) ? $userId : null;
	}

	public function getProjectId() {
		global $projectId;
		return isset($projectId) ? $projectId : null;
	}

	protected function cadastrar() {}

	protected function listar() {}

	protected function exibir($entity) {
		global $projectId;
		global $userId;
		$idProjeto = $projectId !== false ? $projectId : $_GET['exibir'];
		$parameters = array($userId, $idProjeto);

		$role = ucfirst($this->getRole());

		$pgConnect = new PostgresConnection();

		$functionName = lcfirst($entity) . 'Exibir' . $role; // ex: usuarioCadastrar

		$prepare = $pgConnect->prepareFunctionStatementSelect($functionName, count($parameters));

		$retval = $pgConnect->executeFunctionStatement($functionName, $parameters);

		$result = $pgConnect->getArrayOfResultsFromSelect($retval);

		if (!empty($result)) {
			echo '<div class="row-fluid show"><div class="span7">';
			foreach ($result as $row) {
				foreach ($row as $columnName => $columnValue) {
		?>
		<div>
			<strong><?php echo ucfirst($columnName) . ': ';?></strong> <?php echo isset($columnValue) ? $columnValue : 'N/A';?>
		</div>
		<?php
				}
			}
			echo '</div>';
			$this->extraCallOnSucessForShow();
			echo '</div>';
		}
		else {
			printErrorMessage('Erro ao exibir ' . $entity);
		}
		$pgConnect->closeConnection();
	}

	protected function extraCallOnSucessForShow(){}

	/**
	 *	Sobrescreva caso necessite de uma operação extra após a finalização de alguma função CRUD
	 *
	 */
	protected function extraCallOnSucessOperation() {}

	protected function login() {
		if (empty($_POST['email']) || empty($_POST['senha'])) {
			$this->show();
			printErrorMessage('Erro, preencha os campos login e senha !');
		}
		else {
			$user = $this->createUser();

			$pgConnect = new PostgresConnection();

			$functionName = 'logar';
			$parameters = array($user->getEmail(), $user->getSenha());

			$prepare = $pgConnect->prepareFunctionStatement($functionName, count($parameters));

			$retval = $pgConnect->executeFunctionStatement($functionName, $parameters);

			$result = $pgConnect->getResult($retval);

			$id = current(current($result));

			$pgConnect->closeConnection();

			if (isset($id) && $id > 0) {
				$this->storeloginOnSession($id);
				redirect('logged/index.php');
			}
			else {
				unset($_POST);
				$this->show();
				printErrorMessage('Erro, login e/ou senha inválidos !');
			}
		}
	}

	protected function createUser() {
		$user = new Usuario();
		$user->setEmail($_POST['email']);
		$user->setSenha($_POST['senha']);
		return $user;
	}

	protected function storeloginOnSession($id) {
		if ($id !== false) {
			$_SESSION['userId'] = $id;
		}
		else {
			unset($_SESSION['userId']);
		}
	}

	private function checkLogin() {
		$pgConnect = new PostgresConnection();

		$functionName = 'isLogado';
		global $userId;
		$parameters = array($userId);

		$prepare = $pgConnect->prepareFunctionStatement($functionName, count($parameters));

		$retval = $pgConnect->executeFunctionStatement($functionName, $parameters);

		$result = $pgConnect->getResult($retval);

		$result = current(current($result));


		$pgConnect->closeConnection();

		return  $result;
	}

	protected function getRole() {
		$pgConnect = new PostgresConnection();

		global $projectId;
		global $userId;

		$idProjeto = $projectId !== false ? $projectId : $_GET['exibir'];
		$parameters = array($userId, $idProjeto);

		$functionName = 'getRole';
		$prepare = $pgConnect->prepareFunctionStatement($functionName, count($parameters));
		$retval = $pgConnect->executeFunctionStatement($functionName, $parameters);
		$result = $pgConnect->getResult($retval);

		$role = current($result);
		$role = $role['getrole'];

		$pgConnect->closeConnection();

		return $role;
	}
}
